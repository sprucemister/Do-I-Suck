# Define UI
ui <- fluidPage(
  
  # Application title
  # titlePanel("Do I Suck Or Does My Team Suck?"),
  
  sidebarLayout(
    
    # Sidebar Panel for Inputs ----
    sidebarPanel(width = 3, style="margin-top: 10px",
      textInput("input_summoner_name",
                  "Summoner Name",
                  value = 'w6f'),
      # selectInput("input_region",
      #             "Region Name",
      #             choices = c('na1'),
      #             selected = 'na1'),
      actionButton('button_reload','Load Summoner', icon = icon("play-circle")),
      hr(),
      sliderInput('input_games_back',
                  'Latest How Many Games',
                  min = 1,
                  max = 100,
                  value = 100,
                  step = 1),
      selectInput('input_champ_select',
                  'What Champs',
                  choices = c('Diana','Cassiopeia'),
                  multiple = TRUE,
                  selectize = TRUE),
      uiOutput("output_selection_helptext")
    ),
    
    # Main Panel for Plots ----
    mainPanel(width=9,
      fluidRow(
        uiOutput("output_story"),
        hr()
      ),
      fluidRow(
        column(7,
          div(style="font-size: 22px; text-align: center",'Solo Kills'),
          div(class="help-block",style='font-size: 14px;',
              includeHTML("inst/Solo Kills.html")),
          plotOutput("plot_top")),
        column(5,
          div(style="font-size: 22px; text-align: center",'KDA'),
          div(class="help-block",style='font-size: 14px;',
              includeHTML("inst/KDA.html")),
          plotOutput("plot_bottom"))
      )
    )
  )
)

# Server logic
server <- function(session, input, output) {
  
  # Initialize Data Reactive ----
  my_data <- reactiveVal({
    
    # Read CSV generated by Python
    df1 <- readRDS('Initial Data.RDS')
    
    # Wrangle Date
    df1 <- wrangle_data(df1, 'w6f')
    
    # Update Champion Select Input Choices
    updateSelectizeInput(session, 'input_champ_select', 
                         choices = get_champ_list(df1, 'w6f'))
    
    # Return Data
    df1
    
  })
  
  # New API Pull (New Summoner Selected) ----
  observeEvent(input$button_reload, {
    
    # Store inputted summoner and region
    new_summoner <- input$input_summoner_name
    # new_region <- input$input_region
    
    # Python API query for new data and read that data
    print(paste0('Start Python API Query For: ',new_summoner,' @ ',Sys.time()))
    get_api_data(new_summoner,'na1', get_api_key())
    print(paste0('End Python API Query For: ',new_summoner,' @ ',Sys.time()))
    beepr::beep()
    df1 <- tibble(read.csv('Temp - Raw API Data.csv'))
    
    # Wrangle Data
    df1 <- wrangle_data(df1, new_summoner)
    
    # Store wrangled data in reactive
    my_data(df1)
    
    # Update Slider max and value according to # of unique games in data
    val <- length(unique(df1$gameCreation))
    updateSliderInput(session, "input_games_back", value = val, max = val)
    
    # Update Champion Select Input Choices
    updateSelectizeInput(session, 'input_champ_select', 
                         choices = get_champ_list(df1, new_summoner))
  }, 
  ignoreInit = TRUE)
  
  # Plot - Right Output ----
  output$plot_bottom <- renderPlot({
    
    # Get Data
    df1 <- my_data()
    
    # Filter by Games Back Input
    df1 <- df1 %>%
      arrange(desc(gameCreation)) %>%
      slice_head(n = input$input_games_back*10)
    
    # Filter to Champion Selection
    df1 <- df1 %>%
      filter_by_champion(my_champion_list = input$input_champ_select)
    
    # Filter to only your position
    df1 <- df1 %>%
      filter(my_position==TRUE)
    
    # Calculate Column Indicating it's the chosen summoner  
    df1 <- df1 %>%
      mutate(me=case_when(summonerName==isolate(input$input_summoner_name) ~ TRUE,
                          TRUE ~ FALSE))
    
    # Change Values and Column Names for Display
    df1 <- df1 %>%
      mutate(me = case_when(me==TRUE ~ 'Myself',TRUE ~ 'Opposing Laner')) %>% 
      rename(Player = me) %>% 
      mutate(win = case_when(win=='True' ~ 'Win',TRUE ~ 'Loss')) %>% 
      rename(`Result` = win) %>% 
      rename(`KDA` = kda)
    
    
    # Manually Order Positions
    df1$Result <- factor(df1$Result,
                       levels=c("Win", "Loss"))
    
    # Roll Up Data to groups for plotting
    df1 <- df1 %>%
      group_by(Player, `Result`) %>%
      summarize(KDA = round(mean(`KDA`, na.rm=TRUE),1), .groups='drop')
    
    # Make Plot
    df1 %>%
      ggplot(aes(fill=Player, y=KDA, x=`Result`)) + 
      geom_bar(position="dodge", stat="identity", show.legend = FALSE) +
      geom_text(aes(label=KDA),color='black', position=position_dodge(width=0.9), vjust=-.35) +
      ylim(0,max(df1%>%select(KDA))+0.5) +
      scale_fill_manual(values=c("green","black")) +
      theme(panel.background = element_rect(fill='#f5f3f0'),
            strip.text.x = element_text(size = 12),
            axis.title.x=element_blank(),
            axis.title.y=element_blank(),
            axis.text=element_text(size=12),
            plot.title = element_text(hjust = 0.5, size=20))
    
  })
  
  #  Plot - Left Output ----
  output$plot_top <- renderPlot({
    
    # Get Data
    df1 <- my_data()
    
    # Filter by Games Back Input
    df1 <- df1 %>%
      arrange(desc(gameCreation)) %>%
      slice_head(n = input$input_games_back*10)
    
    # Filter by Champion Selection
    df1 <- df1 %>%
      filter_by_champion(my_champion_list = input$input_champ_select)
    
    # Change Values and Column Names for Display
    df1 <- df1 %>%
      mutate(my_team = case_when(my_team==TRUE ~ 'Me / My Team',TRUE ~ 'Opposing Team')) %>% 
      rename(`Team` = my_team) %>% 
      rename(`Role` = teamPosition) %>% 
      mutate(Role = str_to_title(Role)) %>%    
      rename(`Solo Kills` = soloKills) %>%
      mutate(Role = case_when(Role=='Utility' ~ 'Support',TRUE ~ Role)) %>% 
      mutate(my_position = case_when(my_position==TRUE ~ 'Me Versus My Lane Opponent',
                                     TRUE ~ 'My Team Versus Their Lane Opponents'))
      
    # Manually Order Positions
    df1$Role <- factor(df1$Role,
                       levels=c("Top", "Jungle","Middle", "Bottom","Support"))
    
    # Filter Out Bad Data
    df1 <- df1 %>%
      filter(is.na(Role)==FALSE)
    
    # Roll Up Data to groups for plotting
    df1 <- df1 %>%
      group_by(Team, Role, my_position) %>%
      summarize(`Solo Kills` = round(mean(`Solo Kills`, na.rm=TRUE),1), .groups='drop')
      
    # Make Plot
    df1 %>% 
      ggplot(aes(fill=Team, y=`Solo Kills`, x=Role)) + 
      geom_bar(position="dodge", stat="identity", show.legend = FALSE) +
      geom_text(aes(label=`Solo Kills`),color='black', position=position_dodge(width=0.9), vjust=-.35) +
      # scale_colour_manual(values=c("white", "black")) +
      # scale_y_continuous(labels=abs) +
      ylim(0,max(df1%>%select(`Solo Kills`))+0.25) +
      scale_fill_manual(values=c("green","black")) +
      theme(legend.position = "top",
            panel.background = element_rect(fill='#f5f3f0'),
            strip.text.x = element_text(size = 12),
            axis.title.x=element_blank(),
            axis.title.y=element_blank(),
            axis.text=element_text(size=12),
            plot.title = element_text(hjust = 0.5, size=20)) +
      facet_wrap(~my_position, ncol = 1)
  })
  
  # Header Story Output ----
  output$output_story <- renderUI({
    
    # Fire only on Reload Button
    input$button_reload

    # Get Summoner Name
    summoner <- isolate(input$input_summoner_name)
    
    # Get Data
    df1 <- my_data()
    
    # Filter by Games Back Input
    df1 <- df1 %>%
      arrange(desc(gameCreation)) %>%
      slice_head(n = input$input_games_back*10)
    
    # Filter by Champion Selection
    df1 <- df1 %>%
      filter_by_champion(my_champion_list = input$input_champ_select)
    saveRDS(df1,'check_this.rds')
    print(isolate(input$input_summoner_name))
    # Get Stats - Solo Kills
    avg_sk.enemy_team <- filter(df1, my_team==FALSE & my_position==FALSE) %>% pull(`soloKills`) %>% mean()
    avg_sk.my_team <- filter(df1, my_team==TRUE & my_position==FALSE) %>% pull(`soloKills`) %>% mean()
    avg_sk.my_enemy_laner <- filter(df1, my_team==FALSE & my_position==TRUE) %>% pull(`soloKills`) %>% mean()
    avg_sk.myself <- filter(df1, my_team==TRUE & my_position==TRUE) %>% pull(`soloKills`) %>% mean()
    # Rollup Stats - Solo Kills
    avg_sk.diff.team <- avg_sk.my_team-avg_sk.enemy_team
    avg_sk.diff.my_lane <- avg_sk.myself-avg_sk.my_enemy_laner
    print(paste0('Solo Kills - Other Lanes: ', avg_sk.diff.team))
    print(paste0('Solo Kills - My Lane: ', avg_sk.diff.my_lane))
    
    if (is.nan(avg_sk.diff.team)==TRUE) {
      description.sk <- ''
      kpi_sk <- 0
    } else {
      if (avg_sk.diff.team > .14) {
          kpi_sk <- -1
          description.sk <- paste0(summoner,"'s team gets more solo kills than their lane opponents")
        } else if (avg_sk.diff.team < -.14) {
          kpi_sk <- 1
          description.sk <- paste0(summoner,"'s team gets less solo kills than their lane opponents")
        } else {
          kpi_sk <- 0
          description.sk <- paste0(summoner,"'s team gets about the same solo kills as their lane opponents")
        }
    }
    
    # Get Stats - KDA
    avg_kda.win.my_enemy_laner <- filter(df1, my_team==FALSE & my_position==TRUE & win=='True') %>% pull(kda) %>% mean()
    avg_kda.win.myself <- filter(df1, my_team==TRUE & my_position==TRUE & win=='True') %>% pull(kda) %>% mean()
    avg_kda.loss.my_enemy_laner <- filter(df1, my_team==FALSE & my_position==TRUE & win=='False') %>% pull(kda) %>% mean()
    avg_kda.loss.myself <- filter(df1, my_team==TRUE & my_position==TRUE & win=='False') %>% pull(kda) %>% mean()
    # Rollup Stats - KDA
    avg_kda.diff <- (avg_kda.win.myself-avg_kda.win.my_enemy_laner)+(avg_kda.loss.myself-avg_kda.loss.my_enemy_laner)
    print(paste0('KDA Diff: ', avg_kda.diff))
    
    if (is.nan(avg_kda.diff)==TRUE) {
      description.kda <- ''
      kpi_kda <- 0
    } else {
      if (avg_kda.diff > 1.7) {
        kpi_kda <- 1
        description.kda <- paste0(summoner,"'s KDA is better than his opposing laner")
      } else if (avg_kda.diff < -1.7) {
        kpi_kda <- -1
        description.kda <- paste0(summoner,"'s KDA is worse than his opposing laner")
      } else {
        kpi_kda <- 0
        description.kda <- paste0(summoner,"'s KDA is about the same as his opposing laner")
      }
    }
      
    if (kpi_sk + kpi_kda > 0) {
      header <- paste0(summoner,"'s Team Sucks")
    } else if (kpi_sk + kpi_kda < 0) {
      header <- paste0(summoner," Sucks")
    } else {
      header <- paste0(summoner," Is About As Good As His/Her Team")
    }
    print(nchar(description.kda))
    print(nchar(description.sk))
    # Check if 2 description statements to add separator
    if (nchar(description.kda)==0 | nchar(description.sk)==0) {
      description.separator <- ''
    } else {
      description.separator <- ', and '
    }
    
    # HTML Output
    HTML(paste0('<h2 style="text-align: center;">',header,'</h1>',
            '<p style="text-align: center; font size=19px;">',
            description.kda,description.separator,description.sk,'</p>'))
  })
  
  # Help Text Selection Output ----
  output$output_selection_helptext <- renderUI({
    
    # Get Data
    df1 <- my_data()
    
    # Filter by Games Back Input
    df1 <- df1 %>%
      arrange(desc(gameCreation)) %>%
      slice_head(n = input$input_games_back*10)
    
    # Filter by Champion Selection
    df1 <- df1 %>%
      filter_by_champion(my_champion_list = input$input_champ_select)
    
    # HTML Output Text
    HTML(paste0('<span class="help-block">',nrow(df1)/10,
                ' in the last ',input$input_games_back,
                ' games played on selected champion(s)</span>'))
  })
}

# Complete app with UI and server components
shinyApp(ui, server)